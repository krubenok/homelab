name: Home Assistant Config Check

on:
  pull_request:
    paths:
      - "homeassistant/**"
      - ".github/workflows/homeassistant-check.yml"
  push:
    branches: [main]
    paths:
      - "homeassistant/**"
      - ".github/workflows/homeassistant-check.yml"

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read Home Assistant version
        run: |
          echo "HA_VERSION=$(cat homeassistant/.HA_VERSION)" >> "$GITHUB_ENV"

      - name: Prepare config dir
        run: |
          set -euo pipefail
          config_dir="${RUNNER_TEMP}/ha-config"
          mkdir -p "${config_dir}"

          rsync -a homeassistant/ "${config_dir}/" \
            --exclude ".storage/" \
            --exclude "deps/" \
            --exclude "tts/" \
            --exclude "backups/" \
            --exclude "secrets.yaml" \
            --exclude "secrets.yaml.*"

          # CI needs a secrets file for any `!secret` references. Real secrets stay on the HA VM.
          cp homeassistant/secrets.example.yaml "${config_dir}/secrets.yaml"

      - name: Run check_config (docker)
        run: |
          set -euo pipefail
          config_dir="${RUNNER_TEMP}/ha-config"
          docker run --rm \
            -v "${config_dir}:/config" \
            "ghcr.io/home-assistant/home-assistant:${HA_VERSION}" \
            python -m homeassistant --script check_config --config /config

