name: Sync TrueNAS Apps

on:
  push:
    branches: [main]
    paths:
      # Inputs that can change the composed config pushed to TrueNAS
      - docker/**
      # Sync logic and its pinned deps (uv sync --frozen uses these)
      - scripts/truenas_sync_apps.py
      - pyproject.toml
      - uv.lock
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    environment: TrueNAS Server
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.14"
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/uv.lock
          prune-cache: true
          cache-suffix: "truenas-sync-v1"

      - name: Load 1Password secrets
        uses: 1password/load-secrets-action@v3
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          TRUENAS_HOST: "op://Service Tokens/TrueNAS Scale Apps Automation/hostname"
          TRUENAS_USER: "op://Service Tokens/TrueNAS Scale Apps Automation/username"
          TRUENAS_API_KEY: "op://Service Tokens/TrueNAS Scale Apps Automation/credential"
          CF_ACCESS_CLIENT_ID: "op://Service Tokens/TrueNAS Scale Apps Automation/cloudflare tunnel service token/Header and client ID"
          CF_ACCESS_CLIENT_SECRET: "op://Service Tokens/TrueNAS Scale Apps Automation/cloudflare tunnel service token/Header and client secret"
          CLOUDFLARED_TUNNEL_TOKEN: "op://Service Tokens/CloudFlare Tunnel TrueNAS Scale/credential"

      - name: Sync apps
        run: |
          uv sync --frozen --no-dev
          uv run scripts/truenas_sync_apps.py
